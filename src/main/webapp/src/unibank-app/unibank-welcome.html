<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/iron-icons/av-icons.html">
<link rel="import" href="/bower_components/iron-icons/social-icons.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="/src/unibank-app/unibank-home.html">
<link rel="import" href="/src/unibank-app/unibank-about.html">
<link rel="import" href="/bower_components/polymerfire/firebase-app.html">
<link rel="import" href="/bower_components/polymerfire/firebase-auth.html">

<dom-module id="unibank-welcome">
  <template>
    <style>
		paper-icon-button.logo {
			height:50px;
			width:50px;
		}
		paper-toolbar {
			--paper-toolbar-title: {
				color:black;
				font-family: "Century Gothic", CenturyGothic, AppleGothic, sans-serif;
				font-weight:bold;
			};
			--paper-toolbar-height: 56px;
		}
		paper-material {
			font-family: "Century Gothic", CenturyGothic, AppleGothic, sans-serif;
			font-weight: 4;
		}
		paper-material p {
			line-height:5px;
		}			
		@media (max-width: 600px){
			.bg-only {
				display:none;
			}
		}
		@media (min-width:601px){
			.sm-only{
				display:none;
			}
		}
    </style>
	  <app-location route="{{route}}"></app-location>
	  <app-route route="{{route}}"
				 tail="{{tail}}"></app-route>
	  <paper-header-panel>
		  <paper-toolbar>
			  <paper-icon-button class="logo" src="/img/logo.png" onclick="window.location='/index.html?page=home'"></paper-icon-button>
			  <div class="title">UniBank</div>
			  <paper-menu-button class="sm-only" no-overlap>
				  <paper-icon-button class="dropdown-trigger" icon="menu"></paper-icon-button>
				  <paper-menu class="dropdown-content">
					  <template is="dom-repeat" id="buttonItems1" items="[[buttons]]">
					  	<paper-item on-click="_ClickFunction">{{item.name}}</paper-item>
					  </template>
				  </paper-menu>
			  </paper-menu-button>
			  <template is="dom-repeat" id="buttonItems2" items="{{buttons}}">
				  <paper-button class="bg-only" on-click="_ClickFunction" style="{{item.style}}"><iron-icon icon="{{item.icon}}"></iron-icon>{{item.name}}</paper-button>
			  </template>
		  </paper-toolbar>
	  </paper-header-panel>
	  <iron-pages selected="[[page]]" attr-for-selected="name" selected-attribute="visible" fallback-selection="home">
			<unibank-home name="home"></unibank-home>
		  	<unibank-about name="about"></unibank-about>
	  </iron-pages>
	  <paper-dialog id="loginDialog">
		  <form is="iron-form" id="loginForm">
			  <paper-input name="email" label="Email-ID" required auto-validate error-message="Value required" autofocus></paper-input>
			  <paper-input name="password" label="Password" type="password" required auto-validate error-message="Value required"></paper-input>
			  <paper-button raised on-click="_LoginAction">Login</paper-button>
			  <iron-a11y-keys id="a11y" keys="enter" on-keys-pressed="_LoginAction"></iron-a11y-keys>
			  <paper-button raised onclick="signupDialog.open()" style="background-color:limegreen;">Sign Up</paper-button>
		  </form>
	  </paper-dialog>
	  <paper-dialog id="signupDialog">
		  <form is="iron-form" id="signupForm">
			  <paper-input id="nameinput" name="name" label="Name" required auto-validate error-message="Alphabets and spaces only" pattern="[a-zA-Z][a-zA-Z ]*" autocapitalize="words" autofocus></paper-input>
			  <paper-input name="email" label="Email-ID" required auto-validate error-message="Value required"></paper-input>
			  <paper-input name="password" label="Password" type="password" required auto-validate error-message="Value required"></paper-input>
			  <paper-button raised on-click="_SignUp" style="background-color:limegreen;" align="center">Sign Up</paper-button>
			  <iron-a11y-keys id="a11y" keys="enter" on-keys-pressed="_SignUp"></iron-a11y-keys>
		  </form>
	  </paper-dialog>
	  <firebase-app auth-domain="unibank-11d5b.firebaseapp.com"
					database-url="https://unibank-11d5b.firebaseio.com"
					api-key="AIzaSyAyy70wm-UV3SAfrLP92zv5QPSy01MQnQw">
	  </firebase-app>
	  <firebase-auth id="auth" user="{{user}}" on-error="_authError" status-known="{{statusKnown}}">
	  </firebase-auth>
	  <paper-dialog style="background-color:grey;" id="msgDialog">
		  <paper-material elevation="0" style="padding:5px;" main>
			  [[message]]<br>
			  <div align="center" style="padding-top:10px;">
				  <paper-button raised onclick="msgDialog.close()" style="background-color:white;">OK</paper-button>
			  </div>
		  </paper-material>
	  </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'unibank-welcome',
      properties : {
      	message : String,
      	page: String,
      	tail : {
      		type: Object,
          	observer: '_TailChanged'
      	},
      	statusKnown : {
      	    type : Boolean,
      	    observer : '_StatusKnownChanged'
      	},
      },
      _authError : function(error){
	    //done individually. Shows error in console if not defined or used
	  },
      _TailChanged : function(tail,oldTail){
      	this.page=tail.__queryParams.page;
      	page=this.page;
      	if (page !== null) {
          if (page === 'about') {
          	this.buttons = [
          		{icon: 'verified-user' ,style: 'background-color:white;color:black;' ,name: 'Login'},
          		{icon: 'social:person-add' ,style: 'background-color:limegreen;color:white;' ,name: 'Sign Up'},
          		{icon: 'home' ,style: 'background-color:white;color:black;' ,name: 'Home'}
          	];
          }
          else {
          	this.buttons = [
          		{icon: 'verified-user' ,style: 'background-color:white;color:black;' ,name: 'Login'},
          		{icon: 'social:person-add' ,style: 'background-color:limegreen;color:white;' ,name: 'Sign Up'},
          		{icon: 'av:library-books' ,style: 'background-color:white;color:black;' ,name: 'About'}
          	];
          }
        }
      },
      _StatusKnownChanged : function(statusKnown, oldStatusKnown){
      	if( statusKnown ){
      	    if( this.$.auth.signedIn){
              if (page === 'about') {
                this.buttons = [
                    {icon: 'dashboard' ,style: 'background-color:limegreen;color:white;' ,name: 'Dashboard'},
                    {icon: 'home' ,style: 'background-color:white;color:black;' ,name: 'Home'},
                    {icon: 'exit-to-app' ,style: 'background-color:crimson;color:black;' ,name: 'Logout'}
                ];
              }
              else {
                this.buttons = [
                    {icon: 'dashboard' ,style: 'background-color:limegreen;color:white;' ,name: 'Dashboard'},
                    {icon: 'av:library-books' ,style: 'background-color:white;color:black;' ,name: 'About'},
                    {icon: 'exit-to-app' ,style: 'background-color:crimson;color:black;' ,name: 'Logout'}
                ];
              }
            }
        }
      },
      _ClickFunction : function(e) {
      	switch(e.model.item.name){
      		case 'About' :
      			window.location="/index.html?page=about";
      			break;
      		case 'Home' :
      			window.location="/index.html?page=home";
      			break;
      		case 'Sign Up' :
      			this.$.signupDialog.open();
      			break;
      		case 'Login' :
      			this.$.loginDialog.open();
      			break;
      		case 'Dashboard' :
      			window.location="/unibank-loggedin.html";
      			break;
      		default :
      			window.location="#";
      	}
      },
	  _SignUp : function(){
	  	_this = this;
	  	email = this.$.signupForm.email.value;
	  	password = this.$.signupForm.password.value;
	  	name = this.$.signupForm.name.value;
	  	if(this.$.nameinput.invalid) {
	  		this.message = "Try a valid name";
	  		this.$.msgDialog.open();
	  		return;
	  	}
	  	this.$.auth.createUserWithEmailAndPassword(email, password)
	  		.then(function(){
	  			_this.$.auth.signInWithEmailAndPassword(email,password)
                    //Should be signed in after signup but did not work that way
					.then( function(){
						var user = _this.user;
						if(user != null) {
							user.updateProfile({
							  displayName: name
							}).then(function() {
								window.location.href = '/unibank-loggedin.html';
							}, function(error) {
								_this.message = error.message;
								_this.$.msgDialog.open();
							});
						}
					});
	  		},
	  		function(error){
	  			_this.message = error.message;
				_this.$.msgDialog.open();
	  		});
	  },
	  _LoginAction : function(){
	  	_this = this;
	  	this.$.auth.signInWithEmailAndPassword(this.$.loginForm.email.value, this.$.loginForm.password.value)
	  		.then(function(){ window.location.href = '/unibank-loggedin.html' },
	  		 function(error){
				_this.message = error.message;
				_this.$.msgDialog.open();
	  		 });
	  },
    });
  </script>
</dom-module>
